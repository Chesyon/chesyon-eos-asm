# MeteredSkyPeak
A niche patch for Aurora Lucias. Changes the floor cards for all of Sky Peak, to show X00M instead of a floor number, with X being the number of total completed Sky Peak floors. This is inspired by Celeste's Summit level, so if this description doesn't make any sense, I'd recommend checking [this clip](https://www.youtube.com/watch?v=maJeD31p9VM&t=84s) to see what that looks like.
## The technical details
As of writing, both functions that I hook in aren't documented in [pmdsky-debug](https://github.com/UsernameFodder/pmdsky-debug/), but for the sake of this explanation, I'll call them `CreateFloorCardText` and `GetFloorNumString`, located at 0x2017968 [EU] and 0x20247F8 [EU] respectively. `CreateFloorCardText` seems like an obvious place to hook; we're trying to modify the floor card, after all. *However*, apparently this function is completely different between US and EU[^1]. Chunsoft was clearly on *something* when they made the US version of this function, because it's weird as hell ( ***why does it have division??*** ),  and my guess is that they realized this when adding multi-language support, and chose to rewrite the majority of it. My point being: this is why the patch is EU only. The patch would have to be written in a completely different manner for US (either that, or just porting EU's `CreateFloorCardText` to US...)

Ahem. Enough about weird Chunsoft code, more about the patch. You can assume I'm specifically talking about EU's `CreateFloorCardText` from now on. That being said, the function actually just uses the `[floor]` text tag to create the floor number text... which means I'd have to write a LOT of code to conditionally not use the tag, and instead use custom text. I decided this simply wasn't worth it, and instead, we'd hook while handling the `[floor]` text tag. In the first hook, we check if we're in a Sky Peak dungeon, and if so, we bump up the 'floor number' getting passed into the text tag by (dungeon_id << 8). So for Sky Peak dungeons, the floor number getting passed into the tag will be YYXX instead of 00XX, where Y is the dungeon ID, and X is the actual floor number. This serves two purposes. In the second hook, in `GetFloorNumString`, the function responsible for handling the `[floor]` tag, we check this number, and we check if YYXX is greater than or equal to 256. If it is, YY cannot be 00, which means we're handling a Sky Peak dungeon! Now that we know we're handling a Sky Peak dungeon, we can venture off into fully custom code territory. Reverting the bitshift on YY can give us the dungeon ID, and XX will still be the floor number. From there, we just do some basic math to sum up the floors and get our final number, which we write into the string. And we're done! Hooray!

[^1]: `CreateFloorCardText` in JP and US are the same.

